#include "MyAdaptationManager.h"
#include "managers/adaptation/UtilityScorer.h"
#include "managers/execution/AllTactics.h"

using namespace std;

Define_Module(MyAdaptationManager);

Tactic* MyAdaptationManager::evaluate() {
    MacroTactic* pMacroTactic = new MacroTactic;
    Model* pModel = getModel();
    const double dimmerStep = 1.0 / (pModel->getNumberOfDimmerLevels() - 1);
    double dimmer = pModel->getDimmerFactor();
    bool isServerBooting = pModel->getServers() > pModel->getActiveServers();
    double responseTime = pModel->getObservations().avgResponseTime;
    double basicThroughput = pModel->getObservations().basicThroughput;
    bool Serverflag = true;
    int servers = pModel->getServers();


    //make your adaptation rules
    if (responseTime > RT_THRESHOLD*2 && servers < pModel->getMaxServers() && Serverflag && !isServerBooting) {
        // add server? reduce server? adjust dimmer?
        pMacroTactic->addTactic(new AddServerTactic); // add server
        servers++;
        Serverflag = false;
        //dimmer = dimmer - 0.2;
        //pMacroTactic->addTactic(new SetDimmerTactic(dimmer));

    } else if (responseTime < RT_THRESHOLD) {
        dimmer = dimmer + 0.1;     //method to adjust dimmer value
        pMacroTactic->addTactic(new SetDimmerTactic(min(1.0, dimmer )));
        // only if there is more than one server of spare capacity
        if (!isServerBooting && pModel->getServers() > 1 && Serverflag && !isServerBooting) {
            pMacroTactic->addTactic(new RemoveServerTactic);                        //method to remove server
            Serverflag = false;
                   
            //dimmer = dimmer + 0.1;     //method to adjust dimmer value
            //pMacroTactic->addTactic(new SetDimmerTactic(min(1.0, dimmer )));
        }
        

        /*if (!isServerBooting && servers < pModel->getMaxServers() && Serverflag && !isServerBooting) {   
            pMacroTactic->addTactic(new AddServerTactic);                           //method to add server
            servers++;
            Serverflag = false;
            //dimmer = dimmer - 0.2;
            //pMacroTactic->addTactic(new SetDimmerTactic(dimmer));
        }*/
    } else if(responseTime > RT_THRESHOLD && servers < pModel->getMaxServers() && Serverflag && !isServerBooting){
        pMacroTactic->addTactic(new SetDimmerTactic(dimmer/2));
    }
    //if(basicThroughput > MAX_SERVICE_RATE){
    //    dimmer = min(1.0, dimmer + dimmerStep);                                 
    //    pMacroTactic->addTactic(new SetDimmerTactic(dimmer));                           //method to adjust dimmer
    //}
    

    return pMacroTactic;
}